name: Deploy to Production

on:
  push:
    branches: [ main ]
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
    - name: Deploy to Production
      uses: appleboy/ssh-action@v0.1.5
      with:
        host: ${{ secrets.VPS_HOST }}
        username: ${{ secrets.VPS_USER }}
        key: ${{ secrets.VPS_SSH_KEY }}
        command_timeout: 10m
        script: |
          cd ${{ secrets.VPS_PATH }}

          echo "ğŸš€ Starting production deployment..."

          git fetch origin main
          git checkout main
          git reset --hard origin/main

          # Build ANTES de bajar los contenedores (minimiza downtime)
          echo "ğŸ”¨ Building new image..."
          docker compose build app

          # Restart solo el app (DB y Redis no necesitan reiniciarse)
          echo "â™»ï¸ Restarting app..."
          docker compose up -d --no-deps app

          # Esperar healthcheck en vez de sleep fijo
          echo "â³ Waiting for app to be healthy..."
          for i in $(seq 1 30); do
            if docker compose exec -T app wget -q --spider http://localhost:3000/api/health 2>/dev/null; then
              echo "âœ… App is healthy after ${i}s"
              break
            fi
            if [ "$i" -eq 30 ]; then
              echo "âš ï¸ App health check timed out after 30s"
            fi
            sleep 1
          done

          docker compose ps

          echo "âœ… Production deployment completed"
          echo "ğŸŒ Production URL: https://cinenacional.com"
