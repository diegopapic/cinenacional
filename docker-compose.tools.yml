# docker-compose.tools.yml
# Servicios de mantenimiento que corren v√≠a cron
#
# Ambos usan la misma imagen (Dockerfile.tools) con todas las herramientas.
#
# Uso:
#   docker compose -f docker-compose.yml -f docker-compose.tools.yml run --rm letterboxd-updater
#   docker compose -f docker-compose.yml -f docker-compose.tools.yml run --rm db-backup

services:
  letterboxd-updater:
    build:
      context: .
      dockerfile: Dockerfile.tools
    container_name: cinenacional-letterboxd-updater
    profiles:
      - tools
    environment:
      - DATABASE_URL=postgresql://cinenacional:${POSTGRES_PASSWORD}@postgres:5432/cinenacional
    depends_on:
      postgres:
        condition: service_healthy
    networks:
      - cinenacional-network
    command: ["tsx", "scripts/letterboxd/update-popularity-daily.ts"]

  db-backup:
    build:
      context: .
      dockerfile: Dockerfile.tools
    container_name: cinenacional-db-backup
    profiles:
      - tools
    environment:
      - DB_HOST=postgres
      - DB_PORT=5432
      - DB_NAME=cinenacional
      - DB_USER=cinenacional
      - POSTGRES_PASSWORD=${POSTGRES_PASSWORD}
      - TELEGRAM_BOT_TOKEN=${TELEGRAM_BOT_TOKEN}
      - TELEGRAM_CHAT_ID=${TELEGRAM_CHAT_ID}
    depends_on:
      postgres:
        condition: service_healthy
    networks:
      - cinenacional-network
    volumes:
      - ./backups:/backups
      - ${RCLONE_CONFIG:-/root/.config/rclone}:/root/.config/rclone:ro
    command: ["bash", "scripts/backup-database.sh"]

networks:
  cinenacional-network:
    name: cinenacional_cinenacional-network
    external: true
